<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verification - Processing...</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0a;
            color: #e0e0e0;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        .container {
            text-align: center;
            position: relative;
            width: 100%;
            padding: 20px;
        }

        .spinner {
            width: 60px;
            height: 60px;
            margin: 0 auto 30px;
            border: 4px solid #2a2a2a;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        h1 {
            font-size: 24px;
            font-weight: 600;
            color: #9ca3af;
        }

        .hidden {
            display: none;
        }

        /* Animated Box - BIGGER & PROFESSIONAL */
        .animated-box {
            width: 600px;
            height: 400px;
            position: relative;
            margin: 0 auto;
            background: rgba(26, 26, 26, 0.5);
            backdrop-filter: blur(10px);
        }

        .box-line {
            position: absolute;
            z-index: 1;
        }

        .box-line.top {
            top: 0;
            left: 0;
            height: 3px;
            width: 0;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }

        .box-line.right {
            top: 0;
            right: 0;
            width: 3px;
            height: 0;
            background: linear-gradient(180deg, #764ba2, #667eea);
        }

        .box-line.bottom {
            bottom: 0;
            right: 0;
            height: 3px;
            width: 0;
            background: linear-gradient(270deg, #667eea, #764ba2);
        }

        .box-line.left {
            bottom: 0;
            left: 0;
            width: 3px;
            height: 0;
            background: linear-gradient(0deg, #764ba2, #667eea);
        }

        .box-line.top.error,
        .box-line.right.error,
        .box-line.bottom.error,
        .box-line.left.error {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .box-content {
            opacity: 0;
            padding: 60px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            position: relative;
            z-index: 2;
        }

        .box-content h1 {
            font-size: 36px;
            margin-bottom: 20px;
            color: #fff;
            font-weight: 700;
        }

        .box-content p {
            font-size: 18px;
            color: #9ca3af;
            line-height: 1.8;
            max-width: 450px;
        }

        /* Circle Animation - BIGGER */
        svg {
            width: 160px;
            height: 160px;
            margin-bottom: 30px;
        }

        .circle-bg {
            fill: none;
            stroke: #2a2a2a;
            stroke-width: 4;
        }

        .circle-progress {
            fill: none;
            stroke-width: 4;
            stroke-linecap: round;
            stroke-dasharray: 502;
            stroke-dashoffset: 502;
            transform-origin: center;
            transform: rotate(-90deg);
        }

        .circle-progress.success {
            stroke: #10b981;
            filter: drop-shadow(0 0 20px rgba(16, 185, 129, 0.5));
        }

        .circle-progress.error {
            stroke: #ef4444;
            filter: drop-shadow(0 0 20px rgba(239, 68, 68, 0.5));
        }

        .checkmark {
            fill: none;
            stroke: #10b981;
            stroke-width: 5;
            stroke-linecap: round;
            stroke-linejoin: round;
            stroke-dasharray: 100;
            stroke-dashoffset: 100;
            filter: drop-shadow(0 0 10px rgba(16, 185, 129, 0.8));
        }

        .error-x {
            fill: none;
            stroke: #ef4444;
            stroke-width: 5;
            stroke-linecap: round;
            stroke-dasharray: 100;
            stroke-dashoffset: 100;
            filter: drop-shadow(0 0 10px rgba(239, 68, 68, 0.8));
        }

        /* Exclamation mark for errors */
        .error-exclamation {
            fill: none;
            stroke: #ef4444;
            stroke-width: 6;
            stroke-linecap: round;
            stroke-dasharray: 100;
            stroke-dashoffset: 100;
            filter: drop-shadow(0 0 15px rgba(239, 68, 68, 0.9));
        }

        .button {
            margin-top: 40px;
            padding: 16px 48px;
            font-size: 18px;
            font-weight: 600;
            color: #fff;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }

        .button:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.4);
        }

        @media (max-width: 650px) {
            .animated-box {
                width: 95vw;
                height: 450px;
            }
            .box-content {
                padding: 40px 20px;
            }
            .box-content h1 {
                font-size: 28px;
            }
            .box-content p {
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="loading">
            <div class="spinner"></div>
            <h1>Verifying Your Identity...</h1>
        </div>

        <div id="result" class="hidden">
            <div class="animated-box">
                <div class="box-line top"></div>
                <div class="box-line right"></div>
                <div class="box-line bottom"></div>
                <div class="box-line left"></div>

                <div class="box-content">
                    <svg id="result-icon">
                        <circle class="circle-bg" cx="80" cy="80" r="72"/>
                        <circle class="circle-progress" cx="80" cy="80" r="72"/>

                        <!-- Success checkmark -->
                        <path class="checkmark" d="M 45 80 L 70 105 L 115 60"/>

                        <!-- Error exclamation mark (!) -->
                        <g class="error-exclamation">
                            <line x1="80" y1="50" x2="80" y2="95"/>
                            <circle cx="80" cy="110" r="4" fill="#ef4444" stroke="none"/>
                        </g>
                    </svg>

                    <h1 id="result-title"></h1>
                    <p id="result-message"></p>

                    <button class="button" onclick="window.close()">
                        <i class="fas fa-times"></i>
                        Close Window
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const guild = urlParams.get('guild');
        const user = urlParams.get('user');

        async function verifyUser() {
            try {
                if (!guild || !user) {
                    showResult(false, 'Verification Failed', 'Missing required parameters. Please use the verification button in Discord.');
                    return;
                }

                const userData = JSON.parse(decodeURIComponent(user));

                const response = await fetch('/api/verify', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: userData.id,
                        guildId: guild,
                        username: userData.username,
                        discriminator: userData.discriminator
                    })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    showResult(true, 'Verification Successful!', 'You now have full access to the server.');
                } else if (data.error === 'VPN or Proxy detected') {
                    showResult(false, 'VPN/Proxy Detected', 'Please disable your VPN or proxy connection and try again.');
                } else if (data.error === 'Alt account detected') {
                    showResult(false, 'Alt Account Detected', 'This IP address is already associated with another account in this server.');
                } else {
                    showResult(false, 'Verification Failed', data.message || data.error || 'Please contact a server administrator.');
                }
            } catch (error) {
                console.error('Verification error:', error);
                showResult(false, 'Verification Failed', 'An error occurred. Please try again or contact a server administrator.');
            }
        }

        function showResult(success, title, message) {
            // Hide loading
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('result').classList.remove('hidden');

            // Set content
            document.getElementById('result-title').textContent = title;
            document.getElementById('result-message').textContent = message;

            // Animate!
            animateBox(success);
        }

        function animateBox(success) {
            const tl = gsap.timeline();
            const lines = {
                top: document.querySelector('.box-line.top'),
                right: document.querySelector('.box-line.right'),
                bottom: document.querySelector('.box-line.bottom'),
                left: document.querySelector('.box-line.left')
            };

            // Add error class to lines if failed
            if (!success) {
                Object.values(lines).forEach(line => line.classList.add('error'));
            }

            // Line drawing animation - SMOOTH AS FUCK
            tl.to(lines.top, { width: '100%', duration: 0.5, ease: 'power2.out' })
              .to(lines.right, { height: '100%', duration: 0.5, ease: 'power2.out' }, '-=0.3')
              .to(lines.bottom, { width: '100%', duration: 0.5, ease: 'power2.out' }, '-=0.3')
              .to(lines.left, { height: '100%', duration: 0.5, ease: 'power2.out' }, '-=0.3');

            // Circle animation
            const circleProgress = document.querySelector('.circle-progress');
            circleProgress.classList.add(success ? 'success' : 'error');

            tl.to(circleProgress, {
                strokeDashoffset: 0,
                duration: 1,
                ease: 'power2.inOut'
            }, '-=0.4');

            // Icon animation
            if (success) {
                // Checkmark draws in
                tl.to('.checkmark', {
                    strokeDashoffset: 0,
                    duration: 0.6,
                    ease: 'power2.out'
                }, '-=0.4');
            } else {
                // Exclamation mark SLAMS in with bounce
                tl.fromTo('.error-exclamation line', {
                    strokeDashoffset: 100,
                    scale: 0,
                    transformOrigin: 'center center'
                }, {
                    strokeDashoffset: 0,
                    scale: 1,
                    duration: 0.5,
                    ease: 'back.out(3)'
                }, '-=0.4');

                // Dot appears with pop
                tl.fromTo('.error-exclamation circle', {
                    scale: 0,
                    transformOrigin: 'center center'
                }, {
                    scale: 1,
                    duration: 0.3,
                    ease: 'back.out(4)'
                }, '-=0.1');

                // Shake animation for extra impact
                tl.to('svg', {
                    x: -5,
                    duration: 0.05,
                    repeat: 5,
                    yoyo: true,
                    ease: 'power1.inOut'
                }, '-=0.2');
            }

            // Fade in box content
            tl.to('.box-content', { opacity: 1, duration: 0.4 }, '-=0.6');

            // Typewriter text animation
            const titleText = document.getElementById('result-title').textContent;
            const messageText = document.getElementById('result-message').textContent;

            document.getElementById('result-title').textContent = '';
            document.getElementById('result-message').textContent = '';

            // Typewriter for title - FASTER
            const titleChars = titleText.split('');
            titleChars.forEach((char, i) => {
                tl.call(() => {
                    document.getElementById('result-title').textContent += char;
                }, null, i === 0 ? '-=0.3' : '-=0.035');
            });

            // Typewriter for message
            const messageChars = messageText.split('');
            messageChars.forEach((char, i) => {
                tl.call(() => {
                    document.getElementById('result-message').textContent += char;
                }, null, '-=0.018');
            });

            // Button fade in with bounce
            tl.from('.button', {
                opacity: 0,
                y: 30,
                duration: 0.6,
                ease: 'back.out(2)'
            }, '-=0.5');
        }

        // Start verification
        verifyUser();
    </script>
</body>
</html>
