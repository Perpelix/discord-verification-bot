<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verification - Processing...</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0a;
            color: #e0e0e0;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        .container {
            text-align: center;
            position: relative;
        }

        .spinner {
            width: 60px;
            height: 60px;
            margin: 0 auto 30px;
            border: 4px solid #2a2a2a;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        h1 {
            font-size: 24px;
            font-weight: 600;
            color: #9ca3af;
        }

        .hidden {
            display: none;
        }

        /* Animated Box */
        .animated-box {
            width: 400px;
            height: 250px;
            position: relative;
            margin: 0 auto;
        }

        .box-line {
            position: absolute;
            background: linear-gradient(135deg, #667eea, #764ba2);
        }

        .box-line.top {
            top: 0;
            left: 0;
            height: 3px;
            width: 0;
        }

        .box-line.right {
            top: 0;
            right: 0;
            width: 3px;
            height: 0;
        }

        .box-line.bottom {
            bottom: 0;
            right: 0;
            height: 3px;
            width: 0;
        }

        .box-line.left {
            bottom: 0;
            left: 0;
            width: 3px;
            height: 0;
        }

        .box-content {
            opacity: 0;
            padding: 40px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
        }

        .box-content h1 {
            font-size: 28px;
            margin-bottom: 15px;
            color: #fff;
        }

        .box-content p {
            font-size: 16px;
            color: #9ca3af;
            line-height: 1.6;
        }

        /* Circle Animation */
        svg {
            width: 120px;
            height: 120px;
            margin-bottom: 20px;
        }

        .circle-bg {
            fill: none;
            stroke: #2a2a2a;
            stroke-width: 3;
        }

        .circle-progress {
            fill: none;
            stroke-width: 3;
            stroke-linecap: round;
            stroke-dasharray: 377;
            stroke-dashoffset: 377;
            transform-origin: center;
            transform: rotate(-90deg);
        }

        .circle-progress.success {
            stroke: #10b981;
        }

        .circle-progress.error {
            stroke: #ef4444;
        }

        .checkmark {
            fill: none;
            stroke: #10b981;
            stroke-width: 3;
            stroke-linecap: round;
            stroke-linejoin: round;
            stroke-dasharray: 100;
            stroke-dashoffset: 100;
        }

        .error-x {
            fill: none;
            stroke: #ef4444;
            stroke-width: 3;
            stroke-linecap: round;
            stroke-dasharray: 100;
            stroke-dashoffset: 100;
        }

        .button {
            margin-top: 30px;
            padding: 14px 36px;
            font-size: 16px;
            font-weight: 600;
            color: #fff;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }

        @media (max-width: 500px) {
            .animated-box {
                width: 90vw;
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="loading">
            <div class="spinner"></div>
            <h1>Verifying Your Identity...</h1>
        </div>

        <div id="result" class="hidden">
            <div class="animated-box">
                <div class="box-line top"></div>
                <div class="box-line right"></div>
                <div class="box-line bottom"></div>
                <div class="box-line left"></div>

                <div class="box-content">
                    <svg id="result-icon">
                        <circle class="circle-bg" cx="60" cy="60" r="54"/>
                        <circle class="circle-progress" cx="60" cy="60" r="54"/>
                        <!-- Success checkmark -->
                        <path class="checkmark" d="M 35 60 L 52 77 L 85 44"/>
                        <!-- Error X -->
                        <g class="error-x">
                            <path d="M 40 40 L 80 80"/>
                            <path d="M 80 40 L 40 80"/>
                        </g>
                    </svg>

                    <h1 id="result-title"></h1>
                    <p id="result-message"></p>

                    <button class="button" onclick="window.close()">
                        <i class="fas fa-times"></i>
                        Close Window
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const guild = urlParams.get('guild');
        const user = urlParams.get('user');

        async function verifyUser() {
            try {
                if (!guild || !user) {
                    showResult(false, 'Verification Failed', 'Missing required parameters. Please use the verification button in Discord.');
                    return;
                }

                const userData = JSON.parse(decodeURIComponent(user));

                const response = await fetch('/api/verify', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: userData.id,
                        guildId: guild,
                        username: userData.username,
                        discriminator: userData.discriminator
                    })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    showResult(true, 'Verification Successful!', 'You now have full access to the server.');
                } else if (data.error === 'VPN or Proxy detected') {
                    showResult(false, 'VPN/Proxy Detected', 'Please disable your VPN or proxy connection and try again.');
                } else if (data.error === 'Alt account detected') {
                    showResult(false, 'Alt Account Detected', 'This IP address is already associated with another account in this server.');
                } else {
                    showResult(false, 'Verification Failed', data.message || data.error || 'Please contact a server administrator.');
                }
            } catch (error) {
                console.error('Verification error:', error);
                showResult(false, 'Verification Failed', 'An error occurred. Please try again or contact a server administrator.');
            }
        }

        function showResult(success, title, message) {
            // Hide loading
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('result').classList.remove('hidden');

            // Set content
            document.getElementById('result-title').textContent = title;
            document.getElementById('result-message').textContent = message;

            // Animate!
            animateBox(success);
        }

        function animateBox(success) {
            const tl = gsap.timeline();
            const lines = {
                top: document.querySelector('.box-line.top'),
                right: document.querySelector('.box-line.right'),
                bottom: document.querySelector('.box-line.bottom'),
                left: document.querySelector('.box-line.left')
            };

            // Line drawing animation - box forms from a point
            tl.to(lines.top, { width: '100%', duration: 0.4, ease: 'power2.out' })
              .to(lines.right, { height: '100%', duration: 0.4, ease: 'power2.out' }, '-=0.2')
              .to(lines.bottom, { width: '100%', duration: 0.4, ease: 'power2.out' }, '-=0.2')
              .to(lines.left, { height: '100%', duration: 0.4, ease: 'power2.out' }, '-=0.2');

            // Circle animation
            const circleProgress = document.querySelector('.circle-progress');
            circleProgress.classList.add(success ? 'success' : 'error');

            tl.to(circleProgress, {
                strokeDashoffset: 0,
                duration: 0.8,
                ease: 'power2.inOut'
            }, '-=0.3');

            // Icon animation (checkmark or X)
            if (success) {
                tl.to('.checkmark', {
                    strokeDashoffset: 0,
                    duration: 0.5,
                    ease: 'power2.out'
                }, '-=0.3');
            } else {
                tl.to('.error-x path', {
                    strokeDashoffset: 0,
                    duration: 0.4,
                    ease: 'power2.out',
                    stagger: 0.1
                }, '-=0.3');
            }

            // Typewriter text animation
            const titleText = document.getElementById('result-title').textContent;
            const messageText = document.getElementById('result-message').textContent;

            document.getElementById('result-title').textContent = '';
            document.getElementById('result-message').textContent = '';

            tl.to('.box-content', { opacity: 1, duration: 0.3 }, '-=0.5');

            // Typewriter for title
            const titleChars = titleText.split('');
            titleChars.forEach((char, i) => {
                tl.call(() => {
                    document.getElementById('result-title').textContent += char;
                }, null, '-=' + (i === 0 ? 0 : 0.04));
            });

            // Typewriter for message
            const messageChars = messageText.split('');
            messageChars.forEach((char, i) => {
                tl.call(() => {
                    document.getElementById('result-message').textContent += char;
                }, null, '-=' + (i === 0 ? 0 : 0.02));
            });

            // Button fade in
            tl.from('.button', { opacity: 0, y: 20, duration: 0.4, ease: 'power2.out' }, '-=0.3');
        }

        // Start verification
        verifyUser();
    </script>
</body>
</html>
